<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Converter Pro - SND App</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        /* === TEMA (Konsisten) === */
        :root {
            --bg-color: #ffffff;
            --container-color: #f8fafc;
            --text-color: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --primary-color: #2563eb;
            --primary-text: #ffffff;
            --success-color: #16a34a;
            --drag-active: #eff6ff;
            --hover-bg: #f1f5f9;
            --warn-color: #d97706;
        }

        :root[data-theme="dark"] {
            --bg-color: #020817;
            --container-color: #0f172a;
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --input-bg: #1e293b;
            --primary-color: #3b82f6;
            --primary-text: #ffffff;
            --success-color: #22c55e;
            --drag-active: #1e3a8a;
            --hover-bg: #1e293b;
            --warn-color: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .app-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            flex-shrink: 0;
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-color);
            font-weight: 700;
        }

        .back-btn {
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 600;
            margin-right: 1rem;
        }

        .icon-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 6px;
            color: var(--text-color);
            cursor: pointer;
        }

        [data-theme="dark"] .icon-sun {
            display: none;
        }

        [data-theme="light"] .icon-moon {
            display: none;
        }

        /* Layout */
        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 340px;
            border-right: 1px solid var(--border-color);
            background: var(--container-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 0.5rem;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .toggle-icon {
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .sidebar-section.collapsed .section-content {
            display: none;
        }

        .sidebar-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .sidebar-section.collapsed {
            padding-bottom: 0.5rem;
        }

        /* Tree Section */
        #sectionTree {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-bottom: none;
        }

        .tree-scroll-area {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            padding: 10px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: var(--input-bg);
        }

        .upload-zone:hover,
        .upload-zone.active {
            border-color: var(--primary-color);
            background: var(--drag-active);
        }

        #fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Tree Items */
        .tree-ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .tree-ul .tree-ul {
            padding-left: 1.2rem;
        }

        .tree-item {
            margin-bottom: 2px;
        }

        .tree-content {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
        }

        .tree-content:hover {
            background: var(--hover-bg);
        }

        .tree-toggle {
            color: var(--text-muted);
            font-size: 0.7rem;
            width: 10px;
            display: inline-block;
            text-align: center;
        }

        .tree-label {
            font-size: 0.9rem;
            color: var(--text-color);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 5px;
        }

        .tree-children {
            display: none;
        }

        .tree-children.open {
            display: block;
        }

        input[type="checkbox"] {
            accent-color: var(--primary-color);
            cursor: pointer;
            margin: 0;
        }

        /* Export Options */
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--input-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .format-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 10px;
        }

        .format-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .format-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-process {
            width: 100%;
            padding: 0.8rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .btn-process:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--text-muted);
        }

        /* Preview Area */
        .preview-area {
            flex: 1;
            padding: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        th {
            background: var(--container-color);
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: left;
            padding: 10px 12px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        tr:hover td {
            background: var(--hover-bg);
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            text-align: center;
        }

        .status-bar {
            padding-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 600;
            flex-direction: column;
            gap: 10px;
        }

        .watermark {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.4;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .app-body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 60%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .preview-area {
                height: 40%;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div style="display:flex; align-items:center;">
                <a href="index.html" class="back-btn">← Kembali</a>
                <h1>Universal Converter <span
                        style="font-size:0.7em; opacity:0.7; font-weight:400; margin-left:5px;">v2.3</span></h1>
            </div>
            <button class="icon-btn" id="themeToggle">
                <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </header>

        <div class="app-body">
            <div class="sidebar">
                <div class="sidebar-section" id="sectionUpload">
                    <div class="section-header" onclick="toggleSection('sectionUpload')">
                        <h3 class="section-title">1. Input File</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="section-content">
                        <div class="upload-zone" id="dropZone">
                            <p><b>Klik / Drag</b> KMZ atau KML</p>
                            <div id="fileName"
                                style="font-size:0.8rem; margin-top:5px; color:var(--primary-color); word-break:break-all;">
                            </div>
                            <input type="file" id="fileInput" accept=".kmz, .kml">
                        </div>
                    </div>
                </div>

                <div class="sidebar-section" id="sectionTree">
                    <div class="section-header" style="cursor: default;">
                        <h3 class="section-title">2. Pilih Folder (Tree)</h3>
                        <span style="font-size:0.7rem; cursor:pointer; color:var(--primary-color);"
                            onclick="toggleAllCheckboxes(true)">All</span>
                    </div>
                    <div class="tree-scroll-area" id="treeContainer">
                        <div
                            style="padding:10px; color:var(--text-muted); text-align:center; font-size:0.9rem; padding-top: 20px;">
                            Belum ada file.
                        </div>
                    </div>
                </div>

                <div class="sidebar-section" id="sectionExport" style="border-bottom: none;">
                    <div class="section-header" onclick="toggleSection('sectionExport')">
                        <h3 class="section-title">3. Export Options</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="section-content">
                        <div class="option-group">
                            <label class="radio-label"><input type="radio" name="exportMode" value="merge"
                                    checked><span><b>Merge All:</b> Gabung 1 Sheet/File</span></label>
                            <label class="radio-label"><input type="radio" name="exportMode"
                                    value="split"><span><b>Split Folder:</b> Pisah Sheet/ZIP</span></label>
                        </div>

                        <div class="format-selector">
                            <button class="format-btn active" onclick="setFormat('xlsx')">Excel</button>
                            <button class="format-btn" onclick="setFormat('csv')">CSV</button>
                            <button class="format-btn" onclick="setFormat('geojson')">GeoJSON</button>
                        </div>
                        <button id="btnConvert" class="btn-process" disabled>Download Data</button>
                    </div>
                </div>
            </div>

            <div class="preview-area">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <h2 style="margin:0; font-size:1.1rem; color:var(--text-color); border:none;">Data Preview</h2>
                </div>

                <div class="table-wrapper">
                    <div id="emptyState" class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1" style="margin-bottom:10px; opacity:0.5;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="12" y1="18" x2="12" y2="12" />
                            <line x1="9" y1="15" x2="15" y2="15" />
                        </svg>
                        <br>Preview data (Max 50 baris)
                    </div>
                    <table id="previewTable" style="display:none;">
                        <thead>
                            <tr id="tableHead"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div class="status-bar">
                    <span id="statusText">Menunggu input...</span>
                    <span id="rowCount"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div>Memproses Data...</div>
    </div>

    <div class="watermark">by FadliGr</div>

    <script>
        // === 1. SYSTEM & THEME ===
        const root = document.documentElement;
        const savedTheme = localStorage.getItem('theme') || 'dark';
        root.dataset.theme = savedTheme;
        document.getElementById('themeToggle').addEventListener('click', () => {
            const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
            root.dataset.theme = next;
            localStorage.setItem('theme', next);
        });

        // === 2. GLOBAL STATE ===
        let globalDataMap = new Map(); // Stores folderID -> Array of Placemark Data
        let folderTree = null;
        let selectedFormat = 'xlsx';
        let originalFileName = "data";

        // === 3. DOM ELEMENTS ===
        const fileInput = document.getElementById('fileInput');
        const treeContainer = document.getElementById('treeContainer');
        const btnConvert = document.getElementById('btnConvert');
        const statusText = document.getElementById('statusText');
        const dropZone = document.getElementById('dropZone');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // === 4. EVENT LISTENERS ===
        function toggleSection(id) { document.getElementById(id).classList.toggle('collapsed'); }

        function setFormat(fmt) {
            selectedFormat = fmt;
            document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function toggleAllCheckboxes(checked) {
            document.querySelectorAll('.tree-checkbox').forEach(cb => cb.checked = checked);
            updatePreview();
        }

        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('active'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
        btnConvert.addEventListener('click', processExport);

        // === 5. FILE PROCESSING ===
        async function handleFile(file) {
            if (!file.name.match(/\.(kmz|kml)$/i)) return alert("Format salah! Harap upload KMZ atau KML.");

            document.getElementById('fileName').textContent = file.name;
            originalFileName = file.name.replace(/\.[^/.]+$/, "");
            showLoading(true);

            try {
                let xmlStr = "";
                if (file.name.endsWith('.kmz')) {
                    const zip = await new JSZip().loadAsync(file);
                    const kml = zip.file("doc.kml") || zip.file(/.kml$/i)[0];
                    if (!kml) throw new Error("No KML found inside KMZ");
                    xmlStr = await kml.async("string");
                } else {
                    xmlStr = await file.text();
                }

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlStr, "application/xml");

                // Reset State
                globalDataMap.clear();

                // Build Tree & Extract Data simultaneously
                const rootEl = xmlDoc.querySelector("Document") || xmlDoc.querySelector("kml");
                folderTree = parseRecursive(rootEl, "Root");

                renderTree(folderTree);
                document.getElementById('sectionUpload').classList.add('collapsed');
                updatePreview();
                btnConvert.disabled = false;
                statusText.textContent = "File dimuat.";

            } catch (e) {
                alert("Error: " + e.message);
                statusText.textContent = "Gagal.";
            } finally {
                showLoading(false);
            }
        }

        // === 6. CORE LOGIC: PARSE & EXTRACT ===
        function parseRecursive(xmlNode, path) {
            const folderId = Math.random().toString(36).substr(2, 9);
            const folderName = xmlNode.nodeName === "#document" ? "Root" : (xmlNode.querySelector(":scope > name")?.textContent.trim() || "Folder");

            let placemarksData = [];
            let subfolders = [];

            for (let child of xmlNode.children) {
                if (child.nodeName === "Placemark") {
                    placemarksData.push(extractPlacemarkData(child, path, folderName));
                } else if (child.nodeName === "Folder" || child.nodeName === "Document") {
                    const subName = child.querySelector(":scope > name")?.textContent.trim() || "Sub";
                    subfolders.push(parseRecursive(child, path + "/" + subName));
                }
            }

            // Store data in global map if not empty
            if (placemarksData.length > 0) {
                globalDataMap.set(folderId, placemarksData);
            }

            return {
                id: folderId,
                name: folderName,
                count: placemarksData.length,
                children: subfolders,
                path: path
            };
        }

        function extractPlacemarkData(pm, path, folderName) {
            let data = {
                'Folder': folderName,
                'Path': path,
                'Name': pm.querySelector(":scope > name")?.textContent.trim() || ""
            };

            // Coords
            const coords = pm.querySelector("coordinates")?.textContent.trim();
            if (coords) {
                const p = coords.split(/\s+/)[0].split(',');
                data['Longitude'] = p[0];
                data['Latitude'] = p[1];
            }

            // SimpleData
            pm.querySelectorAll("SimpleData").forEach(sd => {
                data[sd.getAttribute("name")] = sd.textContent.trim();
            });

            // ExtendedData > Data
            pm.querySelectorAll("Data").forEach(d => {
                const v = d.querySelector("value")?.textContent.trim();
                if (v) data[d.getAttribute("name")] = v;
            });

            // Description (Optional, remove if too heavy)
            // data['Description'] = pm.querySelector("description")?.textContent.trim() || "";

            return data;
        }

        // === 7. UI RENDERING ===
        function renderTree(node) {
            treeContainer.innerHTML = "";
            const ul = document.createElement('ul');
            ul.className = "tree-ul";
            ul.appendChild(buildTreeItem(node));
            treeContainer.appendChild(ul);
        }

        function buildTreeItem(node) {
            // Skip rendering if folder and all subfolders are empty
            const totalItems = node.count + countRecursive(node);
            if (totalItems === 0) return document.createElement('span');

            const li = document.createElement('li');
            li.className = "tree-item";

            const div = document.createElement('div');
            div.className = "tree-content";

            // Checkbox
            const cb = document.createElement('input');
            cb.type = "checkbox";
            cb.className = "tree-checkbox";
            cb.checked = true;
            cb.dataset.id = node.id; // This ID links to globalDataMap
            cb.addEventListener('change', (e) => {
                // Check/Uncheck children visually
                li.querySelectorAll('.tree-checkbox').forEach(c => c.checked = e.target.checked);
                updatePreview();
            });

            // Toggle
            const toggle = document.createElement('span');
            toggle.className = "tree-toggle";
            toggle.textContent = node.children.length > 0 ? "▶" : "•";

            // Label
            const label = document.createElement('span');
            label.className = "tree-label";
            label.textContent = `${node.name} (${node.count})`;

            div.append(toggle, cb, label);
            li.appendChild(div);

            if (node.children.length > 0) {
                const subUl = document.createElement('ul');
                subUl.className = "tree-ul tree-children";
                node.children.forEach(child => subUl.appendChild(buildTreeItem(child)));
                li.appendChild(subUl);

                // Auto expand root
                if (node.path === "Root") {
                    subUl.classList.add('open');
                    toggle.textContent = "▼";
                }

                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    subUl.classList.toggle('open');
                    toggle.textContent = subUl.classList.contains('open') ? "▼" : "▶";
                });
            }

            return li;
        }

        function countRecursive(node) {
            return node.children.reduce((acc, child) => acc + child.count + countRecursive(child), 0);
        }

        // === 8. PREVIEW & GATHER DATA ===
        let debounce;
        function updatePreview() {
            clearTimeout(debounce);
            debounce = setTimeout(() => {
                // Gather data based on checked IDs
                const checkedIds = Array.from(document.querySelectorAll('.tree-checkbox:checked')).map(cb => cb.dataset.id);

                // Flatten all selected data
                let previewData = [];
                let totalCount = 0;

                checkedIds.forEach(id => {
                    if (globalDataMap.has(id)) {
                        const items = globalDataMap.get(id);
                        totalCount += items.length;
                        if (previewData.length < 50) { // Only keep first 50 for preview
                            previewData.push(...items);
                        }
                    }
                });
                previewData = previewData.slice(0, 50);

                const tbody = document.getElementById('tableBody');
                const thead = document.getElementById('tableHead');
                const empty = document.getElementById('emptyState');
                const table = document.getElementById('previewTable');

                if (previewData.length === 0) {
                    empty.style.display = 'block'; table.style.display = 'none';
                    document.getElementById('rowCount').textContent = "0 items";
                    return;
                }

                empty.style.display = 'none'; table.style.display = 'table';

                // Dynamic Columns
                let colSet = new Set(['Folder', 'Name', 'Longitude', 'Latitude']);
                previewData.forEach(row => Object.keys(row).forEach(k => colSet.add(k)));
                const cols = Array.from(colSet);

                thead.innerHTML = cols.map(c => `<th>${c}</th>`).join('');
                tbody.innerHTML = previewData.map(row => `<tr>${cols.map(c => `<td>${row[c] || ''}</td>`).join('')}</tr>`).join('');

                document.getElementById('rowCount').textContent = `${totalCount} items selected`;
            }, 100);
        }

        // === 9. EXPORT ===
        async function processExport() {
            const mode = document.querySelector('input[name="exportMode"]:checked').value;
            const checkedIds = Array.from(document.querySelectorAll('.tree-checkbox:checked')).map(cb => cb.dataset.id);

            // Filter map based on selection
            let selectedGroups = [];
            checkedIds.forEach(id => {
                if (globalDataMap.has(id)) {
                    // Find folder name from tree (simplified search for display)
                    // For efficiency, the data items already have 'Folder' property
                    selectedGroups.push({
                        id: id,
                        items: globalDataMap.get(id)
                    });
                }
            });

            if (selectedGroups.length === 0) return alert("Tidak ada data yang dipilih!");

            showLoading(true);
            await new Promise(r => setTimeout(r, 200)); // UI paint

            try {
                if (selectedFormat === 'xlsx') {
                    const wb = XLSX.utils.book_new();

                    if (mode === 'merge') {
                        const allItems = selectedGroups.flatMap(g => g.items);
                        const ws = XLSX.utils.json_to_sheet(allItems);
                        XLSX.utils.book_append_sheet(wb, ws, "Merged Data");
                    } else {
                        selectedGroups.forEach(g => {
                            if (g.items.length === 0) return;
                            let name = g.items[0].Folder.replace(/[\\/?*[\]]/g, "").substring(0, 30) || "Sheet";
                            // Unique name check
                            if (wb.SheetNames.includes(name)) name += "_" + g.id.substring(0, 3);
                            const ws = XLSX.utils.json_to_sheet(g.items);
                            XLSX.utils.book_append_sheet(wb, ws, name);
                        });
                    }
                    XLSX.writeFile(wb, `${originalFileName}.xlsx`);
                }
                else {
                    const zip = new JSZip();
                    if (mode === 'merge') {
                        const allItems = selectedGroups.flatMap(g => g.items);
                        if (selectedFormat === 'csv') {
                            const ws = XLSX.utils.json_to_sheet(allItems);
                            saveSingleFile(XLSX.utils.sheet_to_csv(ws), 'csv');
                        } else {
                            const features = allItems.map(toGeoJSON);
                            saveSingleFile(JSON.stringify({ type: "FeatureCollection", features }, null, 2), 'geojson');
                        }
                    } else {
                        // Split -> ZIP
                        selectedGroups.forEach(g => {
                            if (g.items.length === 0) return;
                            const name = g.items[0].Folder.replace(/[^a-z0-9]/gi, '_');
                            if (selectedFormat === 'csv') {
                                const ws = XLSX.utils.json_to_sheet(g.items);
                                zip.file(`${name}.csv`, XLSX.utils.sheet_to_csv(ws));
                            } else {
                                const features = g.items.map(toGeoJSON);
                                zip.file(`${name}.geojson`, JSON.stringify({ type: "FeatureCollection", features }, null, 2));
                            }
                        });
                        const b = await zip.generateAsync({ type: "blob" });
                        triggerDownload(b, `${originalFileName}.zip`);
                    }
                }
            } catch (e) {
                alert("Export Error: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        function toGeoJSON(item) {
            let geom = null;
            if (item.Longitude && item.Latitude) {
                geom = { type: "Point", coordinates: [parseFloat(item.Longitude), parseFloat(item.Latitude)] };
            }
            return { type: "Feature", properties: item, geometry: geom };
        }

        function saveSingleFile(content, ext) {
            const blob = new Blob([content], { type: "text/plain" });
            triggerDownload(blob, `${originalFileName}.${ext}`);
        }

        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

    </script>
</body>

</html>