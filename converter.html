<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Converter - SND App</title>

    <!-- Vercel Web Analytics -->
    <script>
      window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <!-- Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Global Style -->
    <link rel="stylesheet" href="main.css">

    <style>
        /* === DASHBOARD LAYOUT === */
        :root {
            --bg-color: #F5F5F7;
        }

        :root[data-theme="dark"] {
            --bg-color: #000000;
        }

        html,
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 3fr 1.2fr;
            gap: 1.5rem;
            height: 100%;
            padding: 100px 1.5rem 1.5rem 1.5rem;
            box-sizing: border-box;
        }

        /* LEFT PANEL */
        .workspace-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            padding-right: 8px;
            padding-bottom: 2rem;
        }

        .workspace-panel::-webkit-scrollbar {
            width: 6px;
        }

        .workspace-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .workspace-panel::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
        }

        .tool-header-mini {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tool-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-color);
            margin: 0;
        }

        .tool-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin: 0;
        }

        .version-badge {
            font-size: 0.75rem;
            background: var(--accent-bg);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Cards */
        .card-dashboard {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .section-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid Layout untuk Input */
        .split-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        /* Upload Area */
        .upload-compact {
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            background: rgba(0, 122, 255, 0.02);
            transition: 0.2s;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .upload-compact:hover {
            border-color: var(--primary-color);
            transform: scale(1.01);
            background: rgba(0, 122, 255, 0.05);
        }

        #fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Export Options */
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-color);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .format-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 10px;
        }

        .fmt-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .fmt-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Tree View Custom */
        .tree-container-box {
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-color);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border-color);
        }

        .tree-item {
            margin-bottom: 4px;
        }

        .tree-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .tree-content:hover {
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tree-toggle {
            color: var(--text-muted);
            font-size: 0.7rem;
            width: 15px;
            text-align: center;
        }

        .tree-children {
            padding-left: 1.2rem;
            display: none;
        }

        .tree-children.open {
            display: block;
        }

        input[type="checkbox"] {
            accent-color: var(--primary-color);
            cursor: pointer;
            margin: 0;
        }

        /* Table Preview */
        .table-box {
            max-height: 400px;
            overflow: auto;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
            font-size: 0.8rem;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 700;
            z-index: 10;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        tr:hover td {
            background: rgba(0, 0, 0, 0.02);
        }

        /* RIGHT PANEL */
        .monitor-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            height: 100%;
        }

        .monitor-header {
            background: var(--accent-bg);
            padding: 1rem 1.2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .monitor-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #34C759;
            border-radius: 50%;
            box-shadow: 0 0 8px #34C759;
            animation: pulse 2s infinite;
        }

        .monitor-log-area {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            font-family: 'SF Mono', monospace;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--bg-color);
        }

        .monitor-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        /* Log Bubbles */
        .log-bubble {
            padding: 8px 12px;
            border-radius: 12px;
            border-bottom-left-radius: 2px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            line-height: 1.4;
            font-size: 0.8rem;
        }

        .log-time {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 2px;
            display: block;
            opacity: 0.7;
        }

        /* Animations */
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 1;
            }

            50% {
                transform: scale(1);
                opacity: 0.5;
            }

            100% {
                transform: scale(0.95);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .delay-1 {
            animation-delay: 0.2s;
        }

        .delay-2 {
            animation-delay: 0.4s;
        }

        .delay-3 {
            animation-delay: 0.6s;
        }

        /* Loading Spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .processing .spinner {
            display: block;
        }

        .processing span {
            display: none;
        }

        @media (max-width: 1100px) {
            .split-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-container {
                grid-template-columns: 1fr;
                height: auto;
                overflow: auto;
                padding-top: 90px;
            }

            .workspace-panel {
                overflow: visible;
                padding-bottom: 0;
            }

            .monitor-panel {
                height: 400px;
                margin-bottom: 2rem;
            }
        }
    </style>
</head>

<body>
    <!-- Header via Script Global -->

    <div class="dashboard-container">

        <!-- === WORKSPACE (KIRI) === -->
        <div class="workspace-panel animate-up">

            <!-- Header -->
            <div class="tool-header-mini">
                <div>
                    <h1 class="tool-title">Universal Converter</h1>
                    <p class="tool-desc">Konversi KML/KMZ ke Excel, CSV, atau GeoJSON</p>
                </div>
                <div class="version-badge">v2.3 Pro</div>
            </div>

            <!-- SECTION 1: INPUT & CONFIG -->
            <div class="split-grid">
                <!-- Upload -->
                <div class="card-dashboard animate-up delay-1">
                    <div class="section-label">1. Input File</div>
                    <div class="upload-compact" id="dropZone">
                        <div style="font-size: 2.5rem; margin-bottom: 5px;">ðŸ“‚</div>
                        <p style="color:var(--text-muted); margin:0;">Drop <strong>.KMZ / .KML</strong></p>
                        <span id="fileNameDisplay"
                            style="display:block; margin-top:8px; font-weight:700; color:var(--primary-color); font-size:0.85rem;"></span>
                        <input type="file" id="fileInput" accept=".kmz, .kml">
                    </div>
                </div>

                <!-- Options -->
                <div class="card-dashboard animate-up delay-1">
                    <div class="section-label">2. Opsi Export</div>
                    <div class="option-group">
                        <label class="radio-label"><input type="radio" name="exportMode" value="merge"
                                checked><span><b>Merge All:</b> Gabung 1 File</span></label>
                        <label class="radio-label"><input type="radio" name="exportMode" value="split"><span><b>Split
                                    Folder:</b> Pisah per Folder (ZIP)</span></label>
                    </div>
                    <div class="section-label" style="margin-top:1rem; margin-bottom:0.5rem;">Format Output</div>
                    <div class="format-selector">
                        <button class="fmt-btn active" onclick="setFormat('xlsx')">Excel</button>
                        <button class="fmt-btn" onclick="setFormat('csv')">CSV</button>
                        <button class="fmt-btn" onclick="setFormat('geojson')">GeoJSON</button>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: FOLDER TREE -->
            <div class="card-dashboard animate-up delay-2">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div class="section-label" style="margin:0;">3. Pilih Folder (Tree)</div>
                    <button onclick="toggleAllCheckboxes(true)"
                        style="background:none; border:none; color:var(--primary-color); font-size:0.8rem; cursor:pointer; font-weight:600;">Select
                        All</button>
                </div>
                <div class="tree-container-box" id="treeContainer">
                    <div style="text-align:center; color:var(--text-muted); padding:2rem;">
                        Belum ada file yang dimuat.
                    </div>
                </div>
            </div>

            <!-- SECTION 3: PREVIEW -->
            <div class="card-dashboard animate-up delay-3">
                <div class="section-label">4. Data Preview (Max 50 Rows)</div>
                <div class="table-box">
                    <div id="emptyState" style="padding:3rem; text-align:center; color:var(--text-muted);">
                        <div style="font-size:2rem; margin-bottom:10px; opacity:0.5;">ðŸ‘€</div>
                        <p>Upload file untuk melihat preview data</p>
                    </div>
                    <table id="previewTable" style="display:none;">
                        <thead>
                            <tr id="tableHead"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div
                    style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                    <span id="statusText">Ready.</span>
                    <span id="rowCount">0 items</span>
                </div>
            </div>

        </div>

        <!-- === MONITOR (KANAN) === -->
        <aside class="monitor-panel animate-up" style="animation-delay: 0.2s;">
            <div class="monitor-header">
                <div class="monitor-title">
                    <div class="pulse-dot"></div> Ruang Kendali ðŸš€
                </div>
                <div style="font-size:0.7rem; color:var(--text-muted);">LIVE</div>
            </div>

            <div class="monitor-log-area" id="log">
                <div style="text-align:center; color:var(--text-muted); margin-top:50%;">
                    <div style="font-size:2rem; margin-bottom:10px; opacity:0.5;">ðŸ“¡</div>
                    <p style="font-size:0.85rem;">Menunggu file...</p>
                </div>
            </div>

            <div class="monitor-footer">
                <button id="btnConvert" class="btn-action btn-primary" style="width:100%;" disabled>
                    <span class="spinner"></span>
                    <span>Mulai Konversi</span>
                </button>
            </div>
        </aside>

    </div>

    <!-- Global Script -->
    <script src="script.js"></script>

    <!-- Internal Logic -->
    <script>
        // Global State
        let globalDataMap = new Map();
        let folderTree = null;
        let selectedFormat = 'xlsx';
        let originalFileName = "data";

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const treeContainer = document.getElementById('treeContainer');
        const btnConvert = document.getElementById('btnConvert');
        const statusText = document.getElementById('statusText');
        const dropZone = document.getElementById('dropZone');
        const logEl = document.getElementById('log');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        function setFormat(fmt) {
            selectedFormat = fmt;
            document.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            log('info', `Format output diubah ke: <strong>${fmt.toUpperCase()}</strong>`);
        }

        function toggleAllCheckboxes(checked) {
            document.querySelectorAll('.tree-checkbox').forEach(cb => cb.checked = checked);
            updatePreview();
            log('info', checked ? 'Memilih semua folder' : 'Membatalkan semua pilihan');
        }

        // Drag & Drop
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault(); dropZone.classList.remove('active');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
        btnConvert.addEventListener('click', processExport);

        // Fun Log System
        function log(type, m) {
            if (logEl.innerText.includes("Menunggu file")) logEl.innerHTML = '';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const d = document.createElement('div');
            d.className = `log-bubble`; // Default info style
            if (type === 'success') d.style.borderLeft = "3px solid var(--success-color)";
            if (type === 'error') d.style.borderLeft = "3px solid var(--error-color)";

            d.innerHTML = `<span class="log-time">${time}</span>${m}`;
            logEl.appendChild(d);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function handleFile(file) {
            if (!file.name.match(/\.(kmz|kml)$/i)) return alert("Format salah! Harap upload KMZ atau KML.");

            fileNameDisplay.textContent = file.name;
            originalFileName = file.name.replace(/\.[^/.]+$/, "");

            log('info', `Membaca file: <strong>${file.name}</strong>... ðŸ“–`);

            // Artificial Delay for smoothness
            await new Promise(r => setTimeout(r, 500));

            try {
                let xmlStr = "";
                if (file.name.endsWith('.kmz')) {
                    const zip = await new JSZip().loadAsync(file);
                    const kml = zip.file("doc.kml") || zip.file(/.kml$/i)[0];
                    if (!kml) throw new Error("No KML found inside KMZ");
                    xmlStr = await kml.async("string");
                } else {
                    xmlStr = await file.text();
                }

                log('info', 'Parsing struktur XML... âš™ï¸');
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlStr, "application/xml");

                globalDataMap.clear();
                const rootEl = xmlDoc.querySelector("Document") || xmlDoc.querySelector("kml");
                folderTree = parseRecursive(rootEl, "Root");

                renderTree(folderTree);
                updatePreview();

                btnConvert.disabled = false;
                statusText.textContent = "Siap untuk konversi.";
                log('success', 'File berhasil dimuat! Silakan pilih folder.');

            } catch (e) {
                log('error', "Error: " + e.message);
                alert("Error: " + e.message);
            }
        }

        function parseRecursive(xmlNode, path) {
            const folderId = Math.random().toString(36).substr(2, 9);
            const folderName = xmlNode.nodeName === "#document" ? "Root" : (xmlNode.querySelector(":scope > name")?.textContent.trim() || "Folder");
            let placemarksData = [];
            let subfolders = [];
            for (let child of xmlNode.children) {
                if (child.nodeName === "Placemark") {
                    placemarksData.push(extractPlacemarkData(child, path, folderName));
                } else if (child.nodeName === "Folder" || child.nodeName === "Document") {
                    const subName = child.querySelector(":scope > name")?.textContent.trim() || "Sub";
                    subfolders.push(parseRecursive(child, path + "/" + subName));
                }
            }
            if (placemarksData.length > 0) globalDataMap.set(folderId, placemarksData);
            return { id: folderId, name: folderName, count: placemarksData.length, children: subfolders, path: path };
        }

        function extractPlacemarkData(pm, path, folderName) {
            let data = { 'Folder': folderName, 'Path': path, 'Name': pm.querySelector(":scope > name")?.textContent.trim() || "" };
            const coords = pm.querySelector("coordinates")?.textContent.trim();
            if (coords) {
                const p = coords.split(/\s+/)[0].split(',');
                data['Longitude'] = p[0]; data['Latitude'] = p[1];
            }
            pm.querySelectorAll("SimpleData").forEach(sd => data[sd.getAttribute("name")] = sd.textContent.trim());
            pm.querySelectorAll("Data").forEach(d => {
                const v = d.querySelector("value")?.textContent.trim();
                if (v) data[d.getAttribute("name")] = v;
            });
            return data;
        }

        function renderTree(node) {
            treeContainer.innerHTML = "";
            const ul = document.createElement('ul');
            ul.className = "tree-ul";
            ul.appendChild(buildTreeItem(node));
            treeContainer.appendChild(ul);
        }

        function buildTreeItem(node) {
            const totalItems = node.count + countRecursive(node);
            if (totalItems === 0) return document.createElement('span');
            const li = document.createElement('li'); li.className = "tree-item";
            const div = document.createElement('div'); div.className = "tree-content";
            const cb = document.createElement('input'); cb.type = "checkbox"; cb.className = "tree-checkbox"; cb.checked = true; cb.dataset.id = node.id;

            cb.addEventListener('change', (e) => {
                li.querySelectorAll('input').forEach(c => c.checked = e.target.checked);
                updatePreview();
            });

            const toggle = document.createElement('span'); toggle.className = "tree-toggle"; toggle.textContent = node.children.length > 0 ? "â–¶" : "â€¢";
            const label = document.createElement('span'); label.className = "tree-label"; label.textContent = `${node.name} (${node.count})`;

            div.append(toggle, cb, label); li.appendChild(div);

            if (node.children.length > 0) {
                const subUl = document.createElement('ul'); subUl.className = "tree-children";
                node.children.forEach(child => subUl.appendChild(buildTreeItem(child)));
                li.appendChild(subUl);
                if (node.path === "Root") { subUl.classList.add('open'); toggle.textContent = "â–¼"; }
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation(); subUl.classList.toggle('open');
                    toggle.textContent = subUl.classList.contains('open') ? "â–¼" : "â–¶";
                });
            }
            return li;
        }

        function countRecursive(node) { return node.children.reduce((acc, child) => acc + child.count + countRecursive(child), 0); }

        let debounce;
        function updatePreview() {
            clearTimeout(debounce);
            debounce = setTimeout(() => {
                const checkedIds = Array.from(document.querySelectorAll('.tree-checkbox:checked')).map(cb => cb.dataset.id);
                let previewData = [];
                let totalCount = 0;

                checkedIds.forEach(id => {
                    if (globalDataMap.has(id)) {
                        const items = globalDataMap.get(id);
                        totalCount += items.length;
                        if (previewData.length < 50) previewData.push(...items);
                    }
                });

                const tbody = document.getElementById('tableBody');
                const thead = document.getElementById('tableHead');
                const empty = document.getElementById('emptyState');
                const table = document.getElementById('previewTable');

                if (previewData.length === 0) {
                    empty.style.display = 'block'; table.style.display = 'none';
                    document.getElementById('rowCount').textContent = "0 items";
                    return;
                }

                empty.style.display = 'none'; table.style.display = 'table';

                let colSet = new Set(['Folder', 'Name', 'Longitude', 'Latitude']);
                previewData.forEach(row => Object.keys(row).forEach(k => colSet.add(k)));
                const cols = Array.from(colSet);
                thead.innerHTML = cols.map(c => `<th>${c}</th>`).join('');
                tbody.innerHTML = previewData.slice(0, 50).map(row => `<tr>${cols.map(c => `<td>${row[c] || ''}</td>`).join('')}</tr>`).join('');
                document.getElementById('rowCount').textContent = `${totalCount} items selected`;
            }, 100);
        }

        async function processExport() {
            const mode = document.querySelector('input[name="exportMode"]:checked').value;
            const checkedIds = Array.from(document.querySelectorAll('.tree-checkbox:checked')).map(cb => cb.dataset.id);

            if (checkedIds.length === 0) return alert("Pilih data dulu!");

            btnConvert.disabled = true;
            btnConvert.innerHTML = `<span class="spinner"></span> Memproses...`;
            log('info', 'Memulai proses export... â³');

            // Artificial Delay
            await new Promise(r => setTimeout(r, 800));

            try {
                let selectedGroups = [];
                checkedIds.forEach(id => {
                    if (globalDataMap.has(id)) selectedGroups.push({ id: id, items: globalDataMap.get(id) });
                });

                if (selectedFormat === 'xlsx') {
                    const wb = XLSX.utils.book_new();
                    if (mode === 'merge') {
                        const allItems = selectedGroups.flatMap(g => g.items);
                        const ws = XLSX.utils.json_to_sheet(allItems);
                        XLSX.utils.book_append_sheet(wb, ws, "Merged Data");
                    } else {
                        selectedGroups.forEach(g => {
                            if (g.items.length === 0) return;
                            let name = g.items[0].Folder.replace(/[\\/?*[\]]/g, "").substring(0, 30) || "Sheet";
                            if (wb.SheetNames.includes(name)) name += "_" + g.id.substring(0, 3);
                            const ws = XLSX.utils.json_to_sheet(g.items);
                            XLSX.utils.book_append_sheet(wb, ws, name);
                        });
                    }
                    XLSX.writeFile(wb, `${originalFileName}.xlsx`);
                } else {
                    const zip = new JSZip();
                    if (mode === 'merge') {
                        const allItems = selectedGroups.flatMap(g => g.items);
                        if (selectedFormat === 'csv') {
                            const ws = XLSX.utils.json_to_sheet(allItems);
                            saveSingleFile(XLSX.utils.sheet_to_csv(ws), 'csv');
                        } else {
                            const features = allItems.map(toGeoJSON);
                            saveSingleFile(JSON.stringify({ type: "FeatureCollection", features }, null, 2), 'geojson');
                        }
                    } else {
                        selectedGroups.forEach(g => {
                            if (g.items.length === 0) return;
                            const name = g.items[0].Folder.replace(/[^a-z0-9]/gi, '_');
                            if (selectedFormat === 'csv') {
                                const ws = XLSX.utils.json_to_sheet(g.items);
                                zip.file(`${name}.csv`, XLSX.utils.sheet_to_csv(ws));
                            } else {
                                const features = g.items.map(toGeoJSON);
                                zip.file(`${name}.geojson`, JSON.stringify({ type: "FeatureCollection", features }, null, 2));
                            }
                        });
                        const b = await zip.generateAsync({ type: "blob" });
                        triggerDownload(b, `${originalFileName}.zip`);
                    }
                }
                log('success', 'Data berhasil diexport! ðŸŽ‰');
            } catch (e) {
                log('error', "Export Error: " + e.message);
            } finally {
                btnConvert.disabled = false;
                btnConvert.innerHTML = 'Download Data';
            }
        }

        function toGeoJSON(item) {
            let geom = null;
            if (item.Longitude && item.Latitude) {
                geom = { type: "Point", coordinates: [parseFloat(item.Longitude), parseFloat(item.Latitude)] };
            }
            return { type: "Feature", properties: item, geometry: geom };
        }

        function saveSingleFile(content, ext) {
            const blob = new Blob([content], { type: "text/plain" });
            triggerDownload(blob, `${originalFileName}.${ext}`);
        }

        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>
